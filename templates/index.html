<!DOCTYPE html>
<html>
<head>
    <title>Controle de Bingo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .control-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .selectors { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        select, button { padding: 10px 15px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #3498db; color: white; border: none; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .config-item { display: flex; align-items: center; gap: 5px; }
        .config-item input { width: 60px; padding: 5px; }
        .number-grid { display: grid; grid-template-columns: repeat(15, 1fr); gap: 2px; margin-top: 20px; }
        .number { padding: 15px; text-align: center; background: #3498db; color: white; cursor: pointer; border-radius: 3px; }
        .number.header { background: #2c3e50; font-weight: bold; }
        .number.selected { background: #2ecc71; }
        .results-panel { margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 8px; }
        .winner-item { margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 5px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .counter { color: #666; font-size: 0.9em; }
        select:disabled, input:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .number {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .number-grid {
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }
        .number.header {
            font-weight: bold;
            font-size: 16px;
            height: 30px;
        }
        .status-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-left: auto;
            text-align: right;
        }
        .status-item div {
            margin: 5px 0;
            color: #666;
            font-size: 0.9em;
        }
        .status-item span {
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Bingo</h1>
        
        <div class="control-panel">
            <div class="selectors">
                <select id="evento">
                    <option value="">Selecione o Evento</option>
                </select>
                <select id="rodada">
                    <option value="1">Rodada 1</option>
                    <option value="2">Rodada 2</option>
                    <option value="3">Rodada 3</option>
                    <option value="4">Rodada 4</option>
                    <option value="5">Rodada 5</option>
                    <option value="6">Rodada 6</option>
                </select>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button id="iniciar">Iniciar Rodada</button>
                    <button id="finalizar" style="display: none;">Finalizar Rodada</button>
                </div>
            </div>
            
            <div class="selectors">
                <div class="config-item">
                    <label>Máx 4 Cantos: <span class="counter" id="contador-4cantos">0/0</span></label>
                    <input type="number" id="max_4cantos" min="0" value="1">
                </div>
                <div class="config-item">
                    <label>Máx Cinquinas: <span class="counter" id="contador-cinquinas">0/0</span></label>
                    <input type="number" id="max_cinquinas" min="0" value="1">
                </div>
                <div class="config-item">
                    <label>Máx Cartela Cheia: <span class="counter" id="contador-cartela-cheia">0/0</span></label>
                    <input type="number" id="max_cartela_cheia" min="0" value="1">
                </div>
                <div class="status-item">
                    <div>Cartelas Quentes (1 número): <span id="cartelas-quentes">0</span></div>
                    <div>Cartelas Mornas (2 números): <span id="cartelas-mornas">0</span></div>
                </div>
                </div>
            </div>
        </div>

        <div class="number-grid" id="numeros"></div>
        
        <div class="results-panel">
            <h2>Resultados</h2>
            <div id="quatro-cantos"></div>
            <div id="cinquinas"></div>
            <div id="cartela-cheia"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let numerosSorteados = [];
        let cartelasRodada = [];
        let limites = {
            quatroCantos: 1,
            cinquinas: 1,
            cartelaCheia: 1
        };

        let contadores = {
            quatroCantos: 0,
            cinquinas: 0,
            cartelaCheia: 0
        };

        $(document).ready(function() {
            // Inicializa os valores dos inputs e contadores
            inicializarContadores();
            carregarEventos();
            criarGridNumeros();

            // Atualiza quando valores dos inputs mudam
            $('#max_4cantos, #max_cinquinas, #max_cartela_cheia').on('change', function() {
                limites.quatroCantos = parseInt($('#max_4cantos').val()) || 0;
                limites.cinquinas = parseInt($('#max_cinquinas').val()) || 0;
                limites.cartelaCheia = parseInt($('#max_cartela_cheia').val()) || 0;
                atualizarContadores();
            });

            // Inicializa os contadores corretamente
            limites = {
                quatroCantos: parseInt($('#max_4cantos').val()) || 0,
                cinquinas: parseInt($('#max_cinquinas').val()) || 0,
                cartelaCheia: parseInt($('#max_cartela_cheia').val()) || 0
            };
            
            contadores = {
                quatroCantos: 0,
                cinquinas: 0,
                cartelaCheia: 0
            };
            atualizarContadores();

            $('#iniciar').click(function() {
                contadores = {
                    quatroCantos: 0,
                    cinquinas: 0,
                    cartelaCheia: 0
                };
                atualizarContadores();

                 // Bloquear controles
                $('#evento, #rodada, #max_4cantos, #max_cinquinas').prop('disabled', true);
                $(this).prop('disabled', true);
                limites = {
                    quatroCantos: parseInt($('#max_4cantos').val()) || 0,
                    cinquinas: parseInt($('#max_cinquinas').val()) || 0
                };
                contadores = { quatroCantos: 0, cinquinas: 0 };
                atualizarContadores();

                const evento = $('#evento').val();
                const rodada = $('#rodada').val();
                
                $.post('/iniciar_rodada', { evento, rodada }, function(data) {
                    if (data.status === 'success') {
                        cartelasRodada = data.cartelas;
                        numerosSorteados = [];
                        $('.number').removeClass('selected');
                        $('#contador').text('0');
                        alert(`Rodada ${rodada} iniciada! Cartelas: ${cartelasRodada.length}`);
                    } 
                    else {
                        // Desbloquear se erro
                        $('#evento, #rodada, #max_4cantos, #max_cinquinas, #iniciar').prop('disabled', false);
                    }
                }).fail(function() {
                    // Desbloquear se falha
                    $('#evento, #rodada, #max_4cantos, #max_cinquinas, #iniciar').prop('disabled', false);
                });
                $('#finalizar').show();
                $(this).hide();
            });
            
            $('#finalizar').click(function() {
                if(confirm('Deseja realmente finalizar a rodada? Todos os resultados serão limpos.')) {
                    finalizarRodada();
                }
            });
            
            $(document).on('click', '.number:not(.selected)', function() {
                const num = $(this).data('number');
                $(this).addClass('selected');
                numerosSorteados.push(num);
                if (numerosSorteados.length >= 4) verificarVencedores();
            });
        });

        function finalizarRodada() {
            // Limpar resultados
            $('#quatro-cantos, #cinquinas').empty();
            
            // Limpar números sorteados
            $('.number').removeClass('selected');
            numerosSorteados = [];
            $('#contador').text('0');
            $('#numeros-recentes').empty();
            
            // Resetar contadores
            contadores = { quatroCantos: 0, cinquinas: 0 };
            atualizarContadores();
            
            // Habilitar controles
            $('#evento, #rodada, #max_4cantos, #max_cinquinas, #iniciar').prop('disabled', false);
            $('#finalizar').hide();
            $('#iniciar').show();
        }

        function carregarEventos() {
            $.get('/get_eventos', function(data) {
                $('#evento').empty().append('<option value="">Selecione o Evento</option>');
                data.forEach(e => $('#evento').append(`<option>${e}</option>`));
            });
        }

        function criarGridNumeros() {
            const letras = ['B', 'I', 'N', 'G', 'O'];
            letras.forEach(l => $('#numeros').append(`<div class="number header">${l}</div>`));
            
            for (let i = 0; i < 15; i++) {
                letras.forEach((l, idx) => {
                    const num = i + 1 + (idx * 15);
                    $('#numeros').append(`<div class="number" data-number="${num}">${num}</div>`);
                });
            }
        }

        function verificarVencedores() {
            $.ajax({
                url: '/verificar_vencedor',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    numeros_sorteados: numerosSorteados,
                    cartelas: cartelasRodada
                }),
                success: function(data) {
                    // Processar cartela cheia
                    const disponivelCheia = limites.cartelaCheia - contadores.cartelaCheia;
                    const novosCheia = data.cartela_cheia.slice(0, disponivelCheia);
                    
                    novosCheia.forEach(folha => {
                        $('#cartela-cheia').append(
                            `<div class="winner-item">🎉 CARTELA CHEIA: Folha ${folha}</div>`
                        ).show();
                        contadores.cartelaCheia++;
                    });

                    // Atualizar status
                    $('#cartelas-quentes').text(data.status.quentes);
                    $('#cartelas-mornas').text(data.status.mornas);
                    
                    const novosGanhadores = {
                        quatroCantos: new Set(),
                        cinquinas: new Set()
                    };

                    // Processar 4 cantos
                    data.quatro_cantos.forEach(folha => {
                        if (contadores.quatroCantos < limites.quatroCantos && !novosGanhadores.quatroCantos.has(folha)) {
                            novosGanhadores.quatroCantos.add(folha);
                            contadores.quatroCantos++;
                        }
                    });

                    // Processar cinquinas (linhas, colunas e diagonais)
                    const processarTipo = (vencedores, tipo) => {
                        vencedores.forEach(v => {
                            const idUnico = `${v.folha}-${tipo}-${v.posicao}`;
                            if (contadores.cinquinas < limites.cinquinas && !novosGanhadores.cinquinas.has(idUnico)) {
                                novosGanhadores.cinquinas.add(idUnico);
                                contadores.cinquinas++;
                            }
                        });
                    };

                    processarTipo(data.linhas, 'LINHA');
                    processarTipo(data.colunas, 'COLUNA');
                    processarTipo(data.diagonais, 'DIAGONAL');

                    // Atualizar exibição
                    atualizarExibicao(novosGanhadores);
                    atualizarContadores();
                }
            });
        }

        function processarVencedores(tipo, dados, label, contador) {
            const disponivel = limites[contador] - contadores[contador];
            const novos = dados.slice(0, disponivel);
            
            novos.forEach(folha => {
                $(`#${tipo}`).append(`<div class="winner-item">🎉 ${label}: Folha ${folha}</div>`);
                contadores[contador]++;
            });
        }

        function processarCinquinas(data) {
            const tipos = [
                {dados: data.linhas, label: 'LINHA'},
                {dados: data.colunas, label: 'COLUNA'}, 
                {dados: data.diagonais, label: 'DIAGONAL'}
            ];

            tipos.forEach(t => {
                const disponivel = limites.cinquinas - contadores.cinquinas;
                t.dados.slice(0, disponivel).forEach(v => {
                    $('#cinquinas').append(`<div class="winner-item">🎉 ${t.label} COMPLETA: Folha ${v.folha} (${v.posicao})</div>`);
                    contadores.cinquinas++;
                });
            });
        }

        function atualizarExibicao(novosGanhadores) {
            // 4 Cantos
            novosGanhadores.quatroCantos.forEach(folha => {
                $('#quatro-cantos').append(
                    `<div class="winner-item">🎉 QUATRO CANTOS: Folha ${folha}</div>`
                ).show();
            });

            // Cinquinas
            novosGanhadores.cinquinas.forEach(id => {
                const [folha, tipo, posicao] = id.split('-');
                $('#cinquinas').append(
                    `<div class="winner-item">🎉 ${tipo} COMPLETA: Folha ${folha} (${posicao.replace(/-/g, ' ')})</div>`
                ).show();
            });
        }

        function inicializarContadores() {
            // Seta valores iniciais dos inputs
            $('#max_4cantos').val(limites.quatroCantos);
            $('#max_cinquinas').val(limites.cinquinas);
            $('#max_cartela_cheia').val(limites.cartelaCheia);
            
            // Atualiza exibição
            atualizarContadores();
        }

        function atualizarContadores() {
            $('#contador-4cantos').text(`${contadores.quatroCantos}/${limites.quatroCantos}`);
            $('#contador-cinquinas').text(`${contadores.cinquinas}/${limites.cinquinas}`);
            $('#contador-cartela-cheia').text(`${contadores.cartelaCheia}/${limites.cartelaCheia}`);
        }

        function criarGridNumerosOrdenado() {
            const letras = ['B', 'I', 'N', 'G', 'O'];
            const colunas = [
                Array.from({length: 15}, (_, i) => i + 1),   // B 1-15
                Array.from({length: 15}, (_, i) => i + 16),  // I 16-30
                Array.from({length: 15}, (_, i) => i + 31),  // N 31-45
                Array.from({length: 15}, (_, i) => i + 46),  // G 46-60
                Array.from({length: 15}, (_, i) => i + 61)   // O 61-75
            ];

            // Cabeçalho
            letras.forEach(l => $('#numeros').append(`<div class="number header">${l}</div>`));
            
            // Números ordenados
            for (let i = 0; i < 15; i++) {
                colunas.forEach((col, idx) => {
                    $('#numeros').append(`<div class="number" data-number="${col[i]}" data-letra="${letras[idx]}">${col[i]}</div>`);
                });
            }
        }
    </script>
</body>
</html>